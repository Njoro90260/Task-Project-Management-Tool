{% extends "projects/base.html" %}
{% block title %} Dashboard {% endblock title %}
{% block page %}dashboard{% endblock %}

{% load custom_filters %}

{% block content %}
<div class="header shadow-sm p-3 mb-3 bg-body">
<div class="container">
    <div class="row align-items-center">
        <!-- Welcome Section -->
        <div class="col-md-4 text-center">
            <h2 class="mb-3 welcome-text">Track your projects with ease</h2>
            <h1 class="display-4 welcome-text">{{ overall_progress|floatformat:2 }}%</h1>
        </div>

        <!-- Project Progress Bars -->
        <div class="col-md-4">
            <div class="row gx-2"> <!-- Reduce horizontal spacing -->
                {% for project in user_projects_header %}
                <div class="col-md-2 col-sm-3 col-4 p-1"> <!-- Reduce padding for tighter spacing -->
                    <!-- progress bar -->
                    <div class="progress" style="height: 200px; width: 30px; position: relative; margin: 0 auto;">
                        <div class="progress-bar" role="progressbar"
                            style="height: {{ project_progress|get_item:project.id|floatformat:0 }}%; width: 100%; position: absolute; bottom: 0;"
                            aria-valuenow="{{ project_progress|get_item:project.id|floatformat:0 }}" aria-valuemin="0"
                            aria-valuemax="100">
                        </div>
                        <div class="text-center w-100"
                            style="position: absolute; top: 50%; transform: translateY(-50%); font-size: 12px;">
                            {{ project_progress|get_item:project.id|floatformat:0 }}%

                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <p class="text-muted">No projects found.</p>
                </div>
                {% endfor %}
                <div class="col-12 text-center mt-3">
                    <a href="#projects" class="btn btn-primary">Show all</a>
                </div>
            </div>
        </div>
        <!-- Team Members Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">Your Teams</div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        {% for member in team_members %}
                        <li>{{ member.username }}</li>
                        {% empty %}
                        <li class="text-muted">No team members found.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<hr>
<!-- Overdue & Upcoming Tasks -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">Overdue Tasks</div>
            <div class="card-body">
                {% for task in overdue_tasks %}
                <div class="card mb-2 border-danger h-auto p-2 task-list">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">
                            <a href="{% url 'tasks:task_detail' task_id=task.id %}" class="text-danger">{{ task.title }}</a>
                        </h6>
                        <p class="card-text text-muted mb-1">Due: {{ task.due_date }}</p>
                        <a href="{% url 'tasks:edit_task' task_id=task.id %}" class="btn btn-warning btn-sm">Edit</a>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No overdue tasks.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">Upcoming Tasks</div>
            <div class="card-body">
                {% for task in upcoming_tasks %}
                <div class="card mb-2 border-info h-auto p-2">
                    <div class="card-body p-2 task-list">
                        <h6 class="card-title mb-1">
                            <a href="{% url 'tasks:task_detail' task_id=task.id %}" class="text-info">{{ task.title
                                }}</a>
                        </h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="card-text text-muted mb-0">Due: {{ task.due_date }}</p>
                            <a href="{% url 'tasks:edit_task' task_id=task.id %}"
                                class="btn btn-primary btn-sm">Edit</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No upcoming tasks.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Tasks by Priority -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-secondary">Tasks by Priority</div>
            <div class="card-body">
                <h5 class="text-danger">High Priority</h5>
                <div class="row">
                    {% for task in high_priority_tasks %}
                    <div class="col-md-6">
                        <div class="card mb-2 border-danger h-auto p-2 task-list">
                            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                <span class="fw-bold">{{ task.title }}</span>
                                <span class="badge bg-danger">High</span>
                                <a href="{% url 'tasks:edit_task' task_id=task.id %}"
                                    class="btn btn-warning btn-sm">Edit</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No high-priority tasks.</p>
                    {% endfor %}
                </div>

                <h5 class="text-warning">Medium Priority</h5>
                <div class="row">
                    {% for task in medium_priority_tasks %}
                    <div class="col-md-6">
                        <div class="card mb-2 border-warning h-auto p-2 task-list">
                            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                <span class="fw-bold">{{ task.title }}</span>
                                <span class="badge bg-warning">Medium</span>
                                <a href="{% url 'tasks:edit_task' task_id=task.id %}"
                                    class="btn btn-primary btn-sm">Edit</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No medium-priority tasks.</p>
                    {% endfor %}
                </div>

                <h5 class="text-success">Low Priority</h5>
                <div class="row">
                    {% for task in low_priority_tasks %}
                    <div class="col-md-6">
                        <div class="card mb-2 border-success h-auto p-2">
                            <div class="card-body p-2 d-flex justify-content-between align-items-center task-list">
                                <span class="fw-bold">{{ task.title }}</span>
                                <span class="badge bg-success">Low</span>
                                <a href="{% url 'tasks:edit_task' task_id=task.id %}"
                                    class="btn btn-primary btn-sm">Edit</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No low-priority tasks.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>


    <!-- Recent Comments Section -->
    <div class="col-md-4">
        <div class="comments-section">
            <h5>Recent Comments</h5>
            <ul id="comment-list">
                {% for comment in visible_comments|slice:":5" %}
                <li class="mb-2">
                    <strong>{{ comment.author.username }}</strong> on <em>{{ comment.task.title }}</em>:
                    {{ comment.content }}
                    <small>({{ comment.created_at|date:"M d, Y H:i" }})</small>
                </li>
                {% empty %}
                <li class="empty">No Comments to show.</li>
                {% endfor %}
            </ul>
            {% if visible_comments|length > 5 %}
            <button id="show-more-comments" class="btn btn-primary mt-2">Show More</button>
            {% endif %}
        </div>

        <!-- Modal -->
        <div id="comments-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h5>All Comments</h5>
                <ul id="all-comments-list">
                    {% for comment in visible_comments %}
                    <li>
                        <strong>{{ comment.author.username }}</strong> on <em>{{ comment.task.title }}</em>:
                        {{ comment.content }}
                        <small>({{ comment.created_at|date:"M d, Y H:i" }})</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>
</div>


<!-- Projects Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-4" id="projects">
            <div class="card-header bg-primary">Your Projects</div>
            <div class="card-body">
                <a href="{% url 'projects:create_project_and_tasks' %}" class="btn btn-success btn-sm mb-3">Create a new
                    project</a>
                <div class="row">
                    {% for project in user_projects %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <a href="{% url 'projects:project_detail' project_id=project.id %}">
                                    <strong>{{ project.name }}</strong>
                                </a>
                            </div>
                            <div class="card-body text-center">
                                <div class="progress mb-3">
                                    <div class="progress-bar" role="progressbar"
                                        style="width: {{ project_progress|get_item:project.id|floatformat:0 }}%"
                                        aria-valuenow="{{ project_progress|get_item:project.id|floatformat:0 }}"
                                        aria-valuemin="0" aria-valuemax="100">
                                        {{ project_progress|get_item:project.id|floatformat:0 }}%
                                    </div>
                                </div>
                                <a href="{% url 'projects:assign_role' project.id %}"
                                    class="btn btn-sm btn-primary">Manage</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <p class="text-muted">No projects found.</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Progress Bars Section -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">Task Progress</div>
                            <div class="card-body">
                                <h5>Completed Tasks</h5>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-success" role="progressbar"
                                        style="width: {{ completed_percentage }}%"
                                        aria-valuenow="{{ completed_percentage }}" aria-valuemin="0"
                                        aria-valuemax="100">
                                        {{ completed_percentage|floatformat:2 }}%
                                    </div>
                                </div>

                                <h5>In Progress Tasks</h5>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-warning" role="progressbar"
                                        style="width: {{ in_progress_percentage }}%"
                                        aria-valuenow="{{ in_progress_percentage }}" aria-valuemin="0"
                                        aria-valuemax="100">
                                        {{ in_progress_percentage|floatformat:2 }}%
                                    </div>
                                </div>

                                <h5>Not Started Tasks</h5>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                        style="width: {{ not_started_percentage }}%"
                                        aria-valuenow="{{ not_started_percentage }}" aria-valuemin="0"
                                        aria-valuemax="100">
                                        {{ not_started_percentage|floatformat:2 }}%

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endblock content %}