{% extends "projects/base.html" %}
{% block title %} Dashboard {% endblock title %}
{% block page %}dashboard{% endblock %}

{% load custom_filters %}

{% block page_header %}
<div class="container">
    <div class="row align-items-center">
        <!-- Welcome Section -->
        <div class="col-md-4 text-center">
            <h2 class="mb-3">Track your projects with ease</h2>
            <h1 class="display-4">{{ overall_progress|floatformat:2 }}%</h1>
        </div>

        <!-- Project Progress Bars -->
        <div class="col-md-4">
            <div class="row gx-2"> <!-- Reduce horizontal spacing -->
                {% for project in user_projects_header %}
                <div class="col-md-2 col-sm-3 col-4 p-1"> <!-- Reduce padding for tighter spacing -->
                    <!-- progress bar -->
                    <div class="progress" style="height: 200px; width: 30px; position: relative; margin: 0 auto;">
                        <div class="progress-bar bg-success" role="progressbar"
                            style="height: {{ project_progress|get_item:project.id|floatformat:0 }}%; width: 100%; position: absolute; bottom: 0;"
                            aria-valuenow="{{ project_progress|get_item:project.id|floatformat:0 }}" aria-valuemin="0"
                            aria-valuemax="100">
                        </div>
                        <div class="text-center w-100"
                            style="position: absolute; top: 50%; transform: translateY(-50%); font-size: 12px;">
                            {{ project_progress|get_item:project.id|floatformat:0 }}%

                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <p class="text-muted">No projects found.</p>
                </div>
                {% endfor %}
                <div class="col-12 text-center mt-3">
                    <a href="#projects" class="btn btn-primary">Show all</a>
                </div>
            </div>
        </div>
        <!-- Team Members Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">Your Teams</div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        {% for member in team_members %}
                        <li>{{ member.username }}</li>
                        {% empty %}
                        <li class="text-muted">No team members found.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock page_header %}

{% block content %}
<!-- Overdue & Upcoming Tasks -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">Overdue Tasks</div>
            <ul class="list-group list-group-flush">
                {% for task in overdue_tasks %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <a href="{% url 'tasks:task_detail' task_id=task.id %}">{{ task.title }} (Due: {{ task.due_date
                        }})</a>
                    <a href="{% url 'tasks:edit_task' task_id=task.id %}" class="btn btn-sm btn-warning">Edit</a>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No overdue tasks.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">Upcoming Tasks</div>
            <ul class="list-group list-group-flush">
                {% for task in upcoming_tasks %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <a href="{% url 'tasks:task_detail' task_id=task.id %}">{{ task.title }} (Due: {{ task.due_date
                        }})</a>
                    <a href="{% url 'tasks:edit_task' task_id=task.id %}" class="btn btn-sm btn-primary">Edit</a>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No upcoming tasks.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Tasks by Priority -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">Tasks by Priority</div>
            <div class="card-body">
                <h5 class="text-danger">High Priority</h5>
                <ul class="list-group mb-3">
                    {% for task in high_priority_tasks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ task.title }}
                        <span class="badge bg-danger">High</span>
                        <a href="{% url 'tasks:edit_task' task_id=task.id %}" class="btn btn-sm btn-warning">Edit</a>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No high-priority tasks.</li>
                    {% endfor %}
                </ul>

                <h5 class="text-warning">Medium Priority</h5>
                <ul class="list-group mb-3">
                    {% for task in medium_priority_tasks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ task.title }}
                        <span class="badge bg-warning">Medium</span>
                        <a href="{% url 'tasks:edit_task' task_id=task.id %}" class="btn btn-sm btn-primary">Edit</a>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No medium-priority tasks.</li>
                    {% endfor %}
                </ul>

                <h5 class="text-success">Low Priority</h5>
                <ul class="list-group">
                    {% for task in low_priority_tasks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ task.title }}
                        <span class="badge bg-success">Low</span>
                        <a href="{% url 'tasks:edit_task' task_id=task.id %}" class="btn btn-sm btn-primary">Edit</a>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No low-priority tasks.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Recent Comments Section -->
    <div class="col-md-4">
        <div class="comments-section">
            <h5>Recent Comments</h5>
            <ul id="comment-list">
                {% for comment in visible_comments|slice:":5" %}
                <li class="mb-2">
                    <strong>{{ comment.author.username }}</strong> on <em>{{ comment.task.title }}</em>:
                    {{ comment.content }}
                    <small>({{ comment.created_at|date:"M d, Y H:i" }})</small>
                </li>
                {% empty %}
                <li class="empty">No Comments to show.</li>
                {% endfor %}
            </ul>
            {% if visible_comments|length > 5 %}
            <button id="show-more-comments" class="btn btn-primary mt-2">Show More</button>
            {% endif %}
        </div>
        
        <!-- Modal -->
        <div id="comments-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h5>All Comments</h5>
                <ul id="all-comments-list">
                    {% for comment in visible_comments %}
                    <li>
                        <strong>{{ comment.author.username }}</strong> on <em>{{ comment.task.title }}</em>:
                        {{ comment.content }}
                        <small>({{ comment.created_at|date:"M d, Y H:i" }})</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>
</div>


<!-- Projects Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-4" id="projects">
            <div class="card-header bg-primary text-white">Your Projects</div>
            <div class="card-body">
                <a href="{% url 'projects:create_project_and_tasks' %}" class="btn btn-success btn-sm mb-3">Create a new
                    project</a>
                <div class="row">
                    {% for project in user_projects %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <a href="{% url 'projects:project_detail' project_id=project.id %}" class="text-white">
                                    <strong>{{ project.name }}</strong>
                                </a>
                            </div>
                            <div class="card-body text-center">
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-success" role="progressbar"
                                        style="width: {{ project_progress|get_item:project.id|floatformat:0 }}%"
                                        aria-valuenow="{{ project_progress|get_item:project.id|floatformat:0 }}"
                                        aria-valuemin="0" aria-valuemax="100">
                                        {{ project_progress|get_item:project.id|floatformat:0 }}%
                                    </div>
                                </div>
                                <a href="{% url 'projects:assign_role' project.id %}"
                                    class="btn btn-sm btn-primary">Manage</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <p class="text-muted">No projects found.</p>
                    </div>
                    {% endfor %}
    <!-- Progress Bars Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">Task Progress</div>
                <div class="card-body">
                    <!-- Progress bar for completed tasks -->
                    <h5>Completed Tasks</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">60%</div>
                    </div>

                    <!-- Progress bar for in-progress tasks -->
                    <h5>In Progress Tasks</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100">30%</div>
                    </div>

                    <!-- Progress bar for not started tasks -->
                    <h5>Not Started Tasks</h5>
                    <div class="progress">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">10%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Bars Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">Task Progress</div>
            <div class="card-body">
                <h5>Completed Tasks</h5>
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ completed_percentage }}%"
                        aria-valuenow="{{ completed_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        {{ completed_percentage|floatformat:2 }}%
                    </div>
                </div>

                <h5>In Progress Tasks</h5>
                <div class="progress mb-3">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ in_progress_percentage }}%"
                        aria-valuenow="{{ in_progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        {{ in_progress_percentage|floatformat:2 }}%
                    </div>
                </div>

                <h5>Not Started Tasks</h5>
                <div class="progress">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: {{ not_started_percentage }}%"
                        aria-valuenow="{{ not_started_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        {{ not_started_percentage|floatformat:2 }}%

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}