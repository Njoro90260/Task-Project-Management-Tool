{% extends 'projects/base.html' %}

{% block title %}Task Detail{% endblock title %}

{% block page %}task-detail{% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <h1 class="mb-3 text-primary">{{ task.title }}</h1>
        <h2 class="mb-3 text-primary">Task belongs to {{ project }}</h2>
        <p class="text-muted">{{ task.task_description }}</p>
        <p><strong>Assigned to:</strong> <span class="badge bg-secondary">{{ task.assigned_to.username }}</span></p>
        <p><strong>Created at:</strong> {{ task.created_at|date:"F j, Y, g:i a" }}</p>
    </div>

    <hr>

    <div class="card shadow-sm p-4 mt-4">
        <h3 class="mb-3">Comments</h3>
        <form id="comment-form" data-comment-id="{{ task.id }}" class="mb-4">
            {% csrf_token %}
            <div class="mb-3">
                <textarea id="comment-text" class="form-control" placeholder="Add a comment..." required></textarea>
                <ul id="mention-suggestions" class="suggestion-box list-group mt-2"></ul>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
    </div>

    <div class="card shadow-sm p-4 mt-4">
        <h3 class="mb-3">Upload Files</h3>
        <form id="file-upload-form" enctype="multipart/form-data" data-url="{% url 'tasks:upload_task_file' task.id %}" class="mb-4">
            {% csrf_token %}
            <div class="mb-3">
                <input type="file" id="file-input" name="file" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-success">Upload File</button>
        </form>
    </div>

    <div class="card shadow-sm p-4 mt-4">
        <h3 class="mb-3">Uploaded Files</h3>
        <ul id="file-list" class="list-group">
            {% for file in task.files.all %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        {% if file.file.url|lower|slice:"-3:" == "jpg" or file.file.url|lower|slice:"-3:" == "png" or file.file.url|lower|slice:"-4:" == "jpeg" %}
                            <img src="{{ file.file.url }}" alt="Uploaded Image" class="img-thumbnail" style="width: 100px;">
                        {% elif file.file.url|lower|slice:"-3:" == "mp4" or file.file.url|lower|slice:"-3:" == "mov" or file.file.url|lower|slice:"-3:" == "avi" %}
                            <video src="{{ file.file.url }}" controls class="img-thumbnail" style="width: 150px;"></video>
                        {% elif file.file.url|lower|slice:"-3:" == "pdf" %}
                            <iframe src="{{ file.file.url }}" class="img-thumbnail" width="150px" height="200px"></iframe>
                        {% else %}
                            <a href="{{ file.file.url }}" download class="btn btn-outline-primary">Download {{ file.file.name }}</a>
                        {% endif %}
                    </div>
                    {% if file.uploaded_by == request.user or request.user.is_superuser %}
                    <button class="delete-file-btn btn btn-danger btn-sm" data-file-id="{{ file.id }}">
                        ‚ùå Delete
                    </button>
                    {% endif %}
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No files uploaded yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>

{% endblock content %}